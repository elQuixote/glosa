import ../../src/core/matrix
import unittest

from sequtils import zip

from ../../src/core/constants import
  ETA

proc compareMatricesWithinHalfEta(m1, m2: Matrix): bool =
  let matrices = zip(m1.matrix, m2.matrix)
  result = true
  for r in matrices:
    let rows = zip(r[0], r[1])
    for cells in rows:
      if abs(cells[0] - cells[1]) >= (ETA / 2.0):
        result = false
  if not result:
    checkpoint("m1 was " & $m1)
    checkpoint("m2 was " & $m2)

suite "Testing Matrix equality":
  test "Testing Matrix33 equality":
    check:
      matrix33(
        0.654598, 0.923056, 0.39427,
        0.860851, 0.323978, 0.42195,
        0.875438, 0.481455, 0.488165
      ) == matrix33(
        0.654598, 0.923056, 0.39427,
        0.860851, 0.323978, 0.42195,
        0.875438, 0.481455, 0.488165
      )
    check:
      matrix33(
        0.748499, 0.0352577, 0.427358,
        0.060215, 0.0535409, 0.0441635,
        0.902127, 0.20829, 0.49277
      ) != matrix33(
        0.0, 0.0352577, 0.427358,
        0.060215, 0.0535409, 0.0441635,
        0.902127, 0.20829, 0.49277
      )
    check:
      matrix33(
        0.16446, 0.0175755, 0.610602,
        0.00360363, 0.970212, 0.837779,
        0.63888, 0.00239681, 0.377372
      ) != matrix33(
        0.16446, 0.0175755, 0.610602,
        0.00360363, 0.970212, 0.0,
        0.63888, 0.00239681, 0.377372
      )
  test "Testing Matrix44 equality":
    check:
      matrix44(
        0.842703, 0.397442, 0.567616, 0.166963,
        0.93596, 0.334195, 0.798367, 0.756819,
        0.140659, 0.385214, 0.290447, 0.630126,
        0.00165704, 0.0263847, 0.785817, 0.521719
      ) == matrix44(
        0.842703, 0.397442, 0.567616, 0.166963,
        0.93596, 0.334195, 0.798367, 0.756819,
        0.140659, 0.385214, 0.290447, 0.630126,
        0.00165704, 0.0263847, 0.785817, 0.521719
      )
    check:
      matrix44(
        0.943821, 0.782392, 0.493813, 0.569713,
        0.188637, 0.844566, 0.218942, 0.481519,
        0.635572, 0.287341, 0.760024, 0.778447,
        0.827769, 0.952397, 0.288567, 0.143238
      ) != matrix44(
        0.943821, 0.0, 0.493813, 0.569713,
        0.188637, 0.844566, 0.218942, 0.481519,
        0.635572, 0.287341, 0.760024, 0.778447,
        0.827769, 0.952397, 0.288567, 0.143238
      )
    check:
      matrix44(
        0.870361, 0.0669834, 0.857979, 0.22606,
        0.0298475, 0.285036, 0.638891, 0.174999,
        0.0370702, 0.243132, 0.582941, 0.848545,
        0.0564271, 0.0946135, 0.536325, 0.251461
      ) != matrix44(
        0.870361, 0.0669834, 0.857979, 0.22606,
        0.0298475, 0.285036, 0.638891, 0.174999,
        0.0370702, 0.243132, 0.582941, 0.848545,
        0.0, 0.0946135, 0.536325, 0.251461
      )

suite "Calculating a Matrix determinant":
  proc testDeterminant(m: Matrix, expected: float) {.inline.} =
    let det = determinant(m)
    check:
      det == expected or det - expected < ETA
  test "Calculating a Matrix33 determinant":
    testDeterminant(
      matrix33(
        0.654598, 0.923056, 0.39427,
        0.860851, 0.323978, 0.42195,
        0.875438, 0.481455, 0.488165
      ),
      -0.0248018
    )
    testDeterminant(
      matrix33(
        0.748499, 0.0352577, 0.427358,
        0.060215, 0.0535409, 0.0441635,
        0.902127, 0.20829, 0.49277
      ),
      -0.00206053
    )
    testDeterminant(
      matrix33(
        0.16446, 0.0175755, 0.610602,
        0.00360363, 0.970212, 0.837779,
        0.63888, 0.00239681, 0.377372
      ),
      -0.309209
    )
  test "Calculating a Matrix44 determinant":
    testDeterminant(
      matrix44(
        0.842703, 0.397442, 0.567616, 0.166963,
        0.93596, 0.334195, 0.798367, 0.756819,
        0.140659, 0.385214, 0.290447, 0.630126,
        0.00165704, 0.0263847, 0.785817, 0.521719
      ),
      0.130207
    )
    testDeterminant(
      matrix44(
        0.943821, 0.782392, 0.493813, 0.569713,
        0.188637, 0.844566, 0.218942, 0.481519,
        0.635572, 0.287341, 0.760024, 0.778447,
        0.827769, 0.952397, 0.288567, 0.143238
      ),
      -0.0871421
    )
    testDeterminant(
      matrix44(
        0.870361, 0.0669834, 0.857979, 0.22606,
        0.0298475, 0.285036, 0.638891, 0.174999,
        0.0370702, 0.243132, 0.582941, 0.848545,
        0.0564271, 0.0946135, 0.536325, 0.251461
      ),
      -0.0477751
    )

suite "Inverting a Matrix":
  proc testInvert(m, expected: Matrix) {.inline.} =
    let i = invertNew(m)
    check:
      compareMatricesWithinHalfEta(i, expected)
  test "Inverting a Matrix33":
    testInvert(
      matrix33(
        0.970284, 0.402416, 0.306014,
        0.463309, 0.322302, 0.797735,
        0.774413, 0.225144, 0.188657
      ),
      matrix33(
        -2.21229, -0.130753, 4.14137,
        9.87651, -1.00429, -11.7737,
        -2.70547, 1.73524, 2.35161
      )
    )
    testInvert(
      matrix33(
        0.587459, 0.889692, 0.721541,
        0.963188, 0.486403, 0.154929,
        0.27775, 0.347069, 0.951412
      ),
      matrix33(
        -1.04065, 1.51655, 0.542261,
        2.22216, -0.912182, -1.53672,
        -0.506828, -0.109976, 1.45335
      )
    )
    testInvert(
      matrix33(
        0.635662, 0.360339, 0.430483,
        0.24845, 0.90563, 0.00390712,
        0.297682, 0.993795, 0.603242
      ),
      matrix33(
        1.92726, 0.747694, -1.38016,
        -0.528376, 0.907121, 0.371182,
        -0.0805859, -1.86338, 1.72729
      )
    )
  test "Inverting a Matrix44":
    testInvert(
      matrix44(
        0.831218, 0.0194439, 0.915009, 0.449362,
        0.798808, 0.894752, 0.55049, 0.73255,
        0.892743, 0.237692, 0.467903, 0.865314,
        0.931174, 0.329094, 0.122793, 0.197876
      ),
      matrix44(
        0.0888509, -0.526105, 0.0878617, 1.36168,
        -0.315073, 1.36352, -1.00867, 0.0785983,
        1.39068, 0.498785, -0.976894, -0.732707,
        -0.757107, -0.101471, 1.87031, -1.03024
      )
    )
    testInvert(
      matrix44(
        0.549854, 0.451433, 0.38284, 0.84386,
        0.856649, 0.751606, 0.900506, 0.609867,
        0.73803, 0.327338, 0.315135, 0.379056,
        0.216535, 0.549044, 0.533771, 0.604767
      ),
      matrix44(
        -0.0896467, 0.00134185, 1.69572, -0.939109,
        -9.23385, -8.53797, 12.8456, 13.443,
        5.20353, 7.4236, -10.0071, -8.47466,
        3.82249, 1.1987, -3.43684, -2.73483
      )
    )
    testInvert(
      matrix44(
        0.655098, 0.394202, 0.265046, 0.655969,
        0.262584, 0.0333345, 0.796117, 0.091719,
        0.396946, 0.473434, 0.502067, 0.390883,
        0.521794, 0.392786, 0.547749, 0.667828
      ),
      matrix44(
        4.65631, 1.76595, -0.0109805, -4.80973,
        -0.813936, -1.32077, 4.02247, -1.3735,
        -1.25645, 0.881719, 0.117912, 1.04403,
        -2.12886, -1.32615, -2.45396, 5.2069
      )
    )